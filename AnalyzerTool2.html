<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hummingbird Augus Trans-In Dashboard</title>
    <style>
      * {
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }

      body {
        margin: 0;
        background-color: #f4f6f9;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      h1 {
        text-align: center;
        margin: 5px 0;
        font-size: 28px;
        font-weight: 800;
        color: #333;
      }

      .container {
        display: grid;
        grid-template-columns: 1fr 1fr 0.8fr;
        grid-template-rows: 45% 55%;
        gap: 16px;
        flex-grow: 1;
        padding: 16px;
        height: calc(100vh - 70px);
      }

      .box {
        border-radius: 14px;
        background: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 16px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .box1 {
        grid-column: 1;
        grid-row: 1;
      }
      .box2 {
        grid-column: 2;
        grid-row: 1;
      }
      .box3 {
        grid-column: 1 / 3;
        grid-row: 2;
      }
      .box4 {
        grid-column: 3;
        grid-row: 1 / 3;
      }

      h2 {
        font-size: 18px;
        font-weight: 700;
        color: #333;
        text-align: center;
        margin-bottom: 10px;
      }

      textarea {
        flex: 1;
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        resize: none;
        font-family: monospace;
        font-size: 13px;
        background: #fafafa;
        outline: none;
      }

      .btn {
        border: none;
        border-radius: 8px;
        padding: 8px 14px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
        color: white;
      }

      #open-links {
        background-color: #5b9dd9;
      }
      #loadJson {
        background-color: #28a745;
      }
      #clearAll {
        background-color: #dc3545;
      }
      #clearBtn {
        background-color: #e9ecef;
        color: #333;
      }

      .count-info {
        text-align: center;
        font-size: 13px;
        margin: 4px 0;
        color: #667eea;
      }

      .scroll-list {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fafafa;
        padding: 8px;
        font-size: 13px;
      }

      #charts {
        flex: 1;
        overflow: auto;
        position: relative;
        background: #fff;
        border-radius: 10px;
      }

      .chart-wrapper {
        position: relative;
        width: max-content;
        min-height: 100%;
        margin: auto;
      }

      canvas {
        background: #fff;
        display: block;
      }

      .chart-label {
        position: absolute;
        bottom: 5px;
        font-size: 11px;
        writing-mode: sideways-lr;
        text-orientation: mixed;
        text-align: center;
        user-select: text;
        color: #333;
        text-decoration: none;
        line-height: 1;
        cursor: pointer;
      }

      .chart-label:hover {
        color: #0056b3;
        text-decoration: underline;
      }

      #resultBox {
        flex: 1;
        border-radius: 8px;
        background: #e6f3ff;
        padding: 10px;
        font-size: 13px;
        line-height: 1.4;
        overflow-y: auto;
      }

      #searchHistory {
        flex: 1;
        margin-top: 8px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 6px;
        background: #fafafa;
        font-size: 13px;
      }

      #searchInput {
        flex-grow: 1;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 8px;
        font-size: 13px;
      }

      .search-controls {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }

      #custom-modal {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #333;
        color: #fff;
        padding: 10px 18px;
        border-radius: 8px;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 999;
      }
    </style>
  </head>
  <body>
    <h1>Hummingbird Augus Trans-In Dashboard</h1>

    <div class="container">
      <!-- ID Comparison -->
      <div class="box box1">
        <h2>ID Comparison</h2>
        <textarea
          id="troubleshoot"
          placeholder="Paste Troubleshoot IDs..."
        ></textarea>
        <textarea
          id="fcresearch"
          placeholder="Paste FCResearch IDs..."
          style="margin-top: 8px"
        ></textarea>
        <div class="count-info">
          Troubleshoot: <span id="troubleshoot-count">0</span> | FCResearch:
          <span id="fcresearch-count">0</span>
        </div>
        <button id="open-links" class="btn">Open Unique Links</button>
      </div>

      <!-- JSON Input -->
      <div class="box box2">
        <h2>JSON Loader</h2>
        <textarea id="jsonInput" placeholder="Paste JSON here..."></textarea>
        <div style="display: flex; gap: 10px; margin-top: 8px">
          <button id="loadJson" class="btn" style="flex: 1">Load</button>
          <button id="clearAll" class="btn" style="flex: 1">Clear</button>
        </div>
        <div class="scroll-list" id="trailerButtons" style="margin-top: 8px">
          <p style="color: #999">No data loaded.</p>
        </div>
      </div>

      <!-- Charts -->
      <div class="box box3">
        <h2>Charts</h2>
        <div id="charts">
          <p style="color: #999; text-align: center">
            Load JSON and select a trailer to view chart.
          </p>
        </div>
      </div>

      <!-- Container Search -->
      <div class="box box4">
        <h2>Container Search</h2>
        <div id="resultBox">Results will appear here...</div>
        <div class="search-controls">
          <input id="searchInput" placeholder="Scan Container ID" />
          <button id="clearBtn" class="btn">Clear</button>
        </div>
        <div id="searchHistory"></div>
      </div>
    </div>

    <script>
      const PREFIXES = ["pc99", "paX", "PALLET", "pb", "dz-P-A"];
      const MAX_DATASETS = 20;
      const baseURL =
        "https://qi-fcresearch-na.corp.amazon.com/YHM1/results?s=";
      const colorPalette = [
        "#ffadad",
        "#ffd6a5",
        "#fdffb6",
        "#caffbf",
        "#9bf6ff",
        "#bdb2ff",
        "#ffc6ff",
        "#f28b82",
        "#fbbc04",
        "#ccff90",
      ];
      let datasets = [];

      const troubleshoot = document.getElementById("troubleshoot");
      const fcresearch = document.getElementById("fcresearch");
      const troubleshootCount = document.getElementById("troubleshoot-count");
      const fcresearchCount = document.getElementById("fcresearch-count");
      const openLinks = document.getElementById("open-links");
      const jsonInput = document.getElementById("jsonInput");
      const loadJson = document.getElementById("loadJson");
      const clearAll = document.getElementById("clearAll");
      const trailerButtons = document.getElementById("trailerButtons");
      const charts = document.getElementById("charts");
      const resultBox = document.getElementById("resultBox");
      const searchInput = document.getElementById("searchInput");
      const searchBtn = document.getElementById("searchBtn");
      const clearBtn = document.getElementById("clearBtn");
      const searchHistory = document.getElementById("searchHistory");

      const getIDs = (text) =>
        text
          .split("\n")
          .map((l) => l.trim())
          .filter(Boolean);
      const updateCounts = () => {
        troubleshootCount.textContent = getIDs(troubleshoot.value).length;
        fcresearchCount.textContent = getIDs(fcresearch.value).length;
      };
      troubleshoot.addEventListener("input", updateCounts);
      fcresearch.addEventListener("input", updateCounts);

      openLinks.addEventListener("click", () => {
        const t = getIDs(troubleshoot.value);
        const f = new Set(getIDs(fcresearch.value));
        const unique = t.filter((id) => !f.has(id));
        if (!unique.length) return showModal("No unique IDs.");
        unique.forEach((id) => window.open(baseURL + id, "_blank"));
      });

      window.addEventListener("load", () => {
        datasets = JSON.parse(localStorage.getItem("jsonDatasets") || "[]");
        renderAll();
      });

      loadJson.addEventListener("click", () => {
        if (!jsonInput.value.trim()) return showModal("Paste JSON first.");
        if (datasets.length >= MAX_DATASETS)
          return showModal("Max 20 datasets.");
        try {
          const d = JSON.parse(jsonInput.value);
          const color = colorPalette[datasets.length % colorPalette.length];
          d.color = color;
          d.trailerId = d.trailerId || `Dataset ${datasets.length + 1}`;
          datasets.push(d);
          localStorage.setItem("jsonDatasets", JSON.stringify(datasets));
          jsonInput.value = "";
          renderAll();
        } catch {
          showModal("Invalid JSON format.");
        }
      });

      clearAll.addEventListener("click", () => {
        localStorage.removeItem("jsonDatasets");
        datasets = [];
        renderAll();
      });

      function renderAll() {
        renderButtons();
        charts.innerHTML =
          '<p style="color:#999;text-align:center;">Select a trailer to view chart.</p>';
      }

      function renderButtons() {
        trailerButtons.innerHTML = "";
        if (!datasets.length)
          return (trailerButtons.innerHTML =
            '<p style="color:#999;">No data.</p>');
        datasets.forEach((d) => {
          const b = document.createElement("div");
          b.textContent = d.trailerId;
          b.style.background = d.color;
          b.style.padding = "6px 8px";
          b.style.margin = "3px";
          b.style.borderRadius = "6px";
          b.style.cursor = "pointer";
          b.style.fontWeight = "600";
          b.onclick = () => renderChart(d);
          trailerButtons.appendChild(b);
        });
      }

      // === Chart Builder ===
      function renderChart(dataset) {
        charts.innerHTML = "";
        const matched = [];
        function traverse(obj) {
          if (!obj || typeof obj !== "object") return;
          if (
            obj.container?.scannableId &&
            typeof obj.quantityItems === "number"
          ) {
            const id = obj.container.scannableId;
            if (
              PREFIXES.some((p) => id.startsWith(p)) &&
              obj.quantityItems >= 1
            ) {
              matched.push({ id, qty: obj.quantityItems });
            }
          }
          if (Array.isArray(obj.childContainers))
            obj.childContainers.forEach(traverse);
          else Object.values(obj).forEach(traverse);
        }
        traverse(dataset.transferContainerHierarchy);
        if (!matched.length)
          return (charts.innerHTML =
            "<p style='color:#999;'>No matching containers found.</p>");
        matched.sort((a, b) => a.id.localeCompare(b.id));
        const labels = matched.map((m) => m.id);
        const values = matched.map((m) => m.qty);
        const wrapper = document.createElement("div");
        wrapper.className = "chart-wrapper";
        charts.appendChild(wrapper);
        const canvas = document.createElement("canvas");
        wrapper.appendChild(canvas);
        drawFullChart(canvas, labels, values, dataset.color, wrapper);
      }

      function drawFullChart(canvas, labels, values, color, wrapper) {
        const ctx = canvas.getContext("2d");
        const width = Math.max(labels.length * 60, charts.clientWidth - 40);
        const height = charts.clientHeight - 60;
        canvas.width = width;
        canvas.height = height;
        charts.style.overflowX = "auto";
        const max = Math.max(...values, 1);
        const barWidth = width / labels.length;
        ctx.clearRect(0, 0, width, height);
        ctx.textAlign = "center";
        ctx.font = "10px Inter";
        labels.forEach((label, i) => {
          const val = values[i];
          const x = i * barWidth + barWidth / 2;
          const h = (val / max) * (height - 60);
          const y = height - 40 - h;
          ctx.fillStyle = color;
          ctx.fillRect(x - barWidth / 3, y, barWidth / 1.5, h);
          ctx.fillStyle = "#333";
          ctx.fillText(val, x, y - 5);
          const lbl = document.createElement("a");
          lbl.className = "chart-label";
          lbl.textContent = label;
          lbl.href = baseURL + label;
          lbl.target = "_blank";
          lbl.style.left = `${x - barWidth / 2 + 10}px`;
          lbl.style.width = `${barWidth - 10}px`;
          wrapper.appendChild(lbl);
        });
      }

      // === Search Logic ===
      function findContainer(obj, id) {
        if (obj.container?.scannableId === id) return obj;
        for (const c of obj.childContainers || []) {
          const f = findContainer(c, id);
          if (f) return f;
        }
        return null;
      }

      function getContrastColor(hex) {
        const rgb = parseInt(hex.replace("#", ""), 16);
        const r = (rgb >> 16) & 0xff,
          g = (rgb >> 8) & 0xff,
          b = rgb & 0xff;
        const lum = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        return lum > 0.6 ? "#000" : "#fff";
      }

      searchInput.addEventListener("keydown", (event) => {
        if (event.key !== "Enter") return;

        const id = event.target.value.trim();
        if (!id) return showModal("Scan Container ID");

        let found = null,
          foundData = null;

        for (const d of datasets) {
          for (const i of d.transferContainerHierarchy || []) {
            const f = findContainer(i, id);
            if (f) {
              found = d;
              foundData = f;
              break;
            }
          }
          if (found) break;
        }

        const li = document.createElement("div");
        const color = found ? found.color : "#f8f8f8";
        const textColor = found ? getContrastColor(color) : "#999999";

        resultBox.style.background = color;
        resultBox.style.color = textColor;
        resultBox.innerHTML = found
          ? `
      <p><b>${found.trailerId}</b></p>
      <p><b>Container:</b> ${foundData.container.scannableId}</p>
      <p><b>Type:</b> ${foundData.container.containerType}</p>
      <p><b>Quantity:</b> ${foundData.quantityItems || 0}</p>
      <p><b>Status:</b> ${foundData.containerStatus}</p>
    `
          : `<strong>No match found for:</strong> ${id}`;

        li.textContent = found
          ? `${id} → ${foundData.container.containerType} → ${
              foundData.quantityItems || 0
            }`
          : `${id} → No Match`;

        li.style.cssText = `
    background: ${color};
    color: ${textColor};
    border-radius: 6px;
    padding: 4px;
    margin: 2px 0;
  `;

        searchHistory.prepend(li);
        event.target.value = "";
      });

      clearBtn.addEventListener("click", () => {
        searchHistory.innerHTML = "";
        resultBox.innerHTML = "Results will appear here...";
        resultBox.style.background = "#e6f3ff";
        resultBox.style.color = "#000";
      });

      function showModal(msg) {
        const m = document.createElement("div");
        m.id = "custom-modal";
        m.textContent = msg;
        document.body.appendChild(m);
        setTimeout(() => (m.style.opacity = "1"), 10);
        setTimeout(() => {
          m.style.opacity = "0";
          setTimeout(() => m.remove(), 300);
        }, 2000);
      }
    </script>
  </body>
</html>
